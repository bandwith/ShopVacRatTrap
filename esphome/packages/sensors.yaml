---
# esphome/packages/sensors.yaml

apds9960:
  i2c_id: bus_a
  address: 0x39
  update_interval: 100ms

sensor:
  # APDS9960 Gesture/Proximity Sensor
  - platform: apds9960
    type: PROXIMITY
    name: "APDS9960 Proximity"
    id: apds_proximity

  # VL53L4CX ToF Distance Sensor
  - platform: vl53l4cx
    name: "ToF Distance"
    id: distance_sensor
    update_interval: 100ms
    filters:
      - sliding_window_moving_average:
          window_size: 5

  # LSM6DSOX IMU
  - platform: lsm6dsox
    accel_x:
      name: "Accelerometer X"
      id: accel_x
    accel_y:
      name: "Accelerometer Y"
      id: accel_y
    accel_z:
      name: "Accelerometer Z"
      id: accel_z
    gyro_x:
      name: "Gyroscope X"
      id: gyro_x
    gyro_y:
      name: "Gyroscope Y"
      id: gyro_y
    gyro_z:
      name: "Gyroscope Z"
      id: gyro_z
    update_interval: 50ms

  # BME280 environmental sensor via STEMMA QT (I2C)
  - platform: bme280_i2c
    i2c_id: bus_a
    address: 0x77
    temperature:
      name: ${friendly_name} Environmental Temperature
      id: env_temperature
    humidity:
      name: ${friendly_name} Environmental Humidity
      id: env_humidity
    pressure:
      name: ${friendly_name} Barometric Pressure
      id: env_pressure
    update_interval: 60s

  # Vacuum runtime tracking for maintenance scheduling
  - platform: template
    name: ${friendly_name} Total Vacuum Runtime
    id: vacuum_runtime_sensor
    icon: mdi:vacuum
    unit_of_measurement: minutes
    accuracy_decimals: 1
    device_class: duration
    state_class: total_increasing
    lambda: |-
      return id(total_vacuum_runtime);

  # ESP32 internal temperature monitoring with enhanced thermal management
  - platform: template
    name: ${friendly_name} ESP32 Temperature
    id: esp32_temp
    icon: mdi:thermometer
    unit_of_measurement: °C
    device_class: temperature
    state_class: measurement
    lambda: |-
      return temperatureRead();
    update_interval: 15s
    filters:
      - sliding_window_moving_average:
          window_size: 4
          send_every: 2
      - lambda: |-
          // Enhanced thermal protection
          if (x > id(esp32_temp_critical_threshold).state) {
            ESP_LOGW("thermal", "CRITICAL: ESP32 overheating: %.1f°C - initiating emergency shutdown", x);
            id(last_fault_type) = "THERMAL_CRITICAL";
            id(fault_count)++;
            id(thermal_shutdown_button).press();
            return x;
          }
          if (x > id(esp32_temp_warning_threshold).state) {
            ESP_LOGW("thermal", "WARNING: ESP32 temperature elevated: %.1f°C", x);
          }
          return x;

  # System fault monitoring
  - platform: template
    name: ${friendly_name} Fault Count
    id: fault_count_sensor
    icon: mdi:alert
    accuracy_decimals: 0
    state_class: total_increasing
    lambda: |-
      return id(fault_count);

  # System monitoring sensors
  - platform: wifi_signal
    name: ${friendly_name} WiFi Signal Strength
    id: wifi_signal_sensor
    update_interval: 60s

  - platform: uptime
    name: ${friendly_name} System Uptime
    id: uptime_sensor

binary_sensor:
  # Detection Status Sensors (for Display)
  - platform: template
    id: apds_detection
    lambda: return id(apds_proximity).state > ${apds_proximity_threshold};

  - platform: template
    id: pir_detection
    lambda: return id(ir_presence).state;

  - platform: template
    id: tof_detection
    lambda: return (id(distance_sensor).state < 500 && id(distance_sensor).state > 50);

  # STHS34PF80 IR Presence Sensor
  - platform: sths34pf80
    name: "IR Presence"
    id: ir_presence
    update_interval: 200ms

  # Camera AI Detection Placeholder
  - platform: template
    name: "Camera Rodent Detected"
    id: camera_detect
    lambda: return false; // Placeholder for CV logic

  # 4-of-5 Detection Logic
  - platform: template
    name: "Rodent Detected (4-of-5)"
    id: rodent_detected
    lambda: |-
      int detections = 0;

      // 1. Camera AI (placeholder - requires custom component)
      // if (id(camera_detect).state) detections++;

      // 2. Distance: object between 50-500mm
      if (id(distance_sensor).state < 500 && id(distance_sensor).state > 50) detections++;

      // 3. IR presence detected
      if (id(ir_presence).state) detections++;

      // 4. Vibration pattern (accelerometer threshold)
      float accel_magnitude = sqrt(
        id(accel_x).state * id(accel_x).state +
        id(accel_y).state * id(accel_y).state +
        id(accel_z).state * id(accel_z).state
      );
      if (accel_magnitude > 12.0) detections++;  // m/s² threshold

      // 5. Environmental normal (fault detection)

      return detections >= 4;

    on_press:
      - if:
          condition:
            and:
              - binary_sensor.is_off: trap_triggered
              - lambda: return (millis() - id(last_trigger_time) > (id(cooldown_period).state * id(ms_conversion_factor)));
          then:
            - logger.log: "4-of-5 Detection Confirmed! Activating Trap."
            - script.execute: activate_trap_sequence

text_sensor:
  - platform: template
    name: ${friendly_name} System Voltage
    id: system_voltage
    lambda: return {"${line_voltage}"};

  - platform: template
    name: ${friendly_name} Line Frequency
    id: system_frequency
    lambda: return {"${line_frequency}"};

  - platform: template
    name: ${friendly_name} Safety Standard
    id: system_safety_standard
    lambda: return {"${safety_standard}"};

  - platform: template
    name: ${friendly_name} Max Current Rating
    id: max_current_rating
    lambda: return {"${max_current}"};

  - platform: wifi_info
    ip_address:
      name: ${friendly_name} IP Address
      id: ip_address
    ssid:
      name: ${friendly_name} Connected SSID
      id: wifi_ssid
    mac_address:
      name: ${friendly_name} MAC Address
      id: mac_address

  - platform: version
    name: ${friendly_name} ESPHome Version

  # Fault type reporting
  - platform: template
    name: ${friendly_name} Last Fault Type
    id: last_fault_type_sensor
    icon: mdi:alert-circle
    lambda: |-
      return id(last_fault_type);
