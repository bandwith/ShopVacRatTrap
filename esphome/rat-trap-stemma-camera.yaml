---
packages:
  common: !include packages/common.yaml
  sensors: !include packages/sensors.yaml
  safety: !include packages/safety.yaml
  display: !include packages/display-camera.yaml

substitutions:
  device_name: rat-trap-camera-2025
  friendly_name: ShopVac Rat Trap 2025 with STEMMA Camera

i2c:
  - id: bus_a
    sda: 3
    scl: 4
    scan: true
    frequency: 100kHz
  - id: bus_b
    sda: 8
    scl: 9
    scan: true
    frequency: 400kHz

esp32_camera:
  name: ${friendly_name} Camera
  external_clock:
    pin: GPIO15
    frequency: 20MHz
  i2c_id: bus_b
  data_pins: [GPIO32, GPIO35, GPIO34, GPIO5, GPIO39, GPIO18, GPIO36, GPIO19]
  vsync_pin: GPIO25
  href_pin: GPIO26
  pixel_clock_pin: GPIO27
  power_down_pin: GPIO33
  resolution: 1600x1200
  jpeg_quality: 15
  aec_sensor: true
  aec2: false
  ae_level: 0
  aec_value: 300
  agc_sensor: true
  agc_gain: 0
  bpc: true
  wpc: true
  raw_gma: true
  lenc: true
  special_effect: none
  wb_mode: auto
  test_pattern: false

sensor:
  - platform: apds9960
    address: 0x39
    update_interval: 60s
    proximity:
      name: ${friendly_name} APDS9960 Proximity
      id: apds_proximity
    red_channel:
      name: ${friendly_name} APDS9960 Red
      id: apds_red
    green_channel:
      name: ${friendly_name} APDS9960 Green
      id: apds_green
    blue_channel:
      name: ${friendly_name} APDS9960 Blue
      id: apds_blue
    clear_channel:
      name: ${friendly_name} APDS9960 Clear
      id: apds_clear
  - platform: vl53l0x
    name: ${friendly_name} Trap Distance
    id: trap_distance
    address: 0x29
    update_interval: 50ms
    long_range: true

binary_sensor:
  - platform: gpio
    name: ${friendly_name} PIR Motion Detected
    id: pir_motion
    pin:
      number: GPIO13
      mode: INPUT_PULLDOWN
    filters:
      - delayed_on: 10ms
      - delayed_off: 2000ms
  - platform: template
    name: ${friendly_name} APDS9960 Proximity Detection
    id: apds_detection
    lambda: |-
      float proximity = id(apds_proximity).state;
      return (proximity > 50);
  - platform: template
    name: ${friendly_name} PIR Motion Detection
    id: pir_detection
    lambda: |-
      return id(pir_motion).is_on();
  - platform: template
    name: ${friendly_name} ToF Distance Detection
    id: tof_detection
    lambda: |-
      float distance = id(trap_distance).state;
      float threshold = id(detection_threshold).state;
      return (distance > 0 && distance < threshold);
  - platform: group
    name: ${friendly_name} Rodent Detection Group
    id: rodent_detection_group
    sensors:
      - apds_detection
      - pir_detection
      - tof_detection
    type: count
    on_state:
      - if:
          condition:
            and:
              - binary_sensor.is_on: rodent_detection_group
              - binary_sensor.is_off: trap_triggered
              - not:
                  condition:
                    binary_sensor.is_on: emergency_stop
              - lambda: return (id(homeassistant_time).now().timestamp - id(last_trigger_time)) > 60;
          then:
            - logger.log: 'HYBRID DETECTION: Multiple sensors confirm rodent presence'
            - script.execute: activate_vacuum
            - script.execute: capture_evidence_photo
            - counter.increment: capture_count
            - lambda: id(last_trigger_time) = id(homeassistant_time).now().timestamp;

  - platform: template
    name: ${friendly_name} Trap Triggered
    id: trap_triggered

number:
  - platform: template
    name: ${friendly_name} Detection Threshold (mm)
    id: detection_threshold
    min_value: 50.0
    max_value: 200.0
    step: 5.0
    initial_value: 150.0
    optimistic: true
    unit_of_measurement: mm
  - platform: template
    name: ${friendly_name} Vacuum Runtime (seconds)
    id: vacuum_runtime
    min_value: 3.0
    max_value: 30.0
    step: 1.0
    initial_value: 10.0
    optimistic: true
    unit_of_measurement: s
  - platform: template
    name: ${friendly_name} IR LED Brightness (%)
    id: ir_brightness_number
    min_value: 10
    max_value: 100
    step: 5
    initial_value: 80
    optimistic: true
    restore_value: true

counter:
  - platform: template
    name: ${friendly_name} Capture Count
    id: capture_count
    restore_value: yes
    initial_value: 0

globals:
  - id: last_trigger_time
    type: time_t
    initial_value: '0'
    restore_value: true

script:
  - id: activate_vacuum
    then:
      - logger.log: ACTIVATING VACUUM - Multi-sensor confirmation received
      - switch.turn_on: vacuum_relay
      - delay: !lambda "return id(vacuum_runtime).state * 1000;"
      - switch.turn_off: vacuum_relay
      - logger.log: VACUUM CYCLE COMPLETE
  - id: emergency_shutdown
    then:
      - logger.log: EMERGENCY SHUTDOWN - All vacuum operations halted
      - input_boolean.turn_off: system_armed
      - switch.turn_off: vacuum_relay
      - output.turn_off: ir_led_output
      - deep_sleep:
          sleep_duration: 60s
  - id: rearm_system
    then:
      - logger.log: SYSTEM REARMED - Detection active
      - input_boolean.turn_on: system_armed
  - id: capture_evidence_photo
    then:
      - logger.log: CAPTURING EVIDENCE PHOTO
      - output.turn_on: ir_led_output
      - delay: 500ms
      - esp32_camera.capture:
      - delay: 200ms
      - output.turn_off: ir_led_output
      - logger.log: Evidence photo captured and sent to Home Assistant

switch:
  - platform: gpio
    name: ${friendly_name} Vacuum Relay
    id: vacuum_relay
    pin: GPIO5
    restore_mode: ALWAYS_OFF
  - platform: template
    name: ${friendly_name} System Armed
    id: system_armed_switch
    lambda: |-
      return id(system_armed).state;
    turn_on_action:
      - script.execute: rearm_system
    turn_off_action:
      - script.execute: emergency_shutdown

output:
  - platform: ledc
    pin: 6
    id: ir_led_output
    frequency: 1000Hz

time:
  - platform: homeassistant
    id: homeassistant_time

button:
  - platform: restart
    name: ${friendly_name} Restart ESP32
    id: restart_button
  - platform: template
    name: ${friendly_name} Test Capture
    id: test_capture_button
    on_press:
      - script.execute: activate_vacuum
      - script.execute: capture_evidence_photo
  - platform: template
    name: ${friendly_name} Reset Capture Count
    id: reset_count_button
    on_press:
      - counter.set:
          id: capture_count
          value: 0
      - logger.log: Capture count reset to 0

status_led:
  pin:
    number: 13
    inverted: true

web_server:
  port: 80
  version: 2
  include_internal: true
