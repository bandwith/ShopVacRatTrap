---
name: Generate STL Files from SCAD

on:
  push:
    branches:
      - main
  pull_request:
    paths:
      - 3d_models/**.scad
  workflow_dispatch:
    inputs:
      force_regenerate:
        description: Force regenerate all STL files even if unchanged
        required: false
        default: false
        type: boolean

jobs:
  generate-stl:
    runs-on: ubuntu-latest
    outputs:
      should_commit: ${{ steps.generate.outputs.should_commit }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Get pip cache dir
        id: pip-cache
        run: |
          echo "dir=$(pip cache dir)" >> $GITHUB_OUTPUT
      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ${{ steps.pip-cache.outputs.dir }}
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements-dev.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt

      - name: Install OpenSCAD
        run: |
          sudo apt-get update && sudo apt-get install -y openscad

      - name: Cache apt packages
        uses: actions/cache@v4
        with:
          path: /var/cache/apt/archives
          key: ${{ runner.os }}-apt-openscad
          restore-keys: |
            ${{ runner.os }}-apt-openscad-

      - name: Generate STL files
        id: generate
        run: |
          if [[ "${{ github.event.inputs.force_regenerate }}" == "true" ]]; then
            scad_files=$(python .github/scripts/stl_generator_helper.py --get-all-files)
          else
            changed_files=$(python .github/scripts/stl_generator_helper.py --get-changed-files)
            missing_files=$(python .github/scripts/stl_generator_helper.py --get-missing-files)
            scad_files=$(jq -n --argjson a "$changed_files" --argjson b "$missing_files" '$a + $b | unique')
          fi

          if [[ -z "$scad_files" || "$scad_files" == "[]" ]]; then
            echo "No SCAD files to process."
            echo "should_commit=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "should_commit=true" >> $GITHUB_OUTPUT

          echo "$scad_files" | jq -r '.[] | @sh' | while read -r file; do
            openscad -o "3d_models/$(basename "$file" .scad).stl" "$file"
          done

      - name: Generate build report
        if: steps.generate.outputs.should_commit == 'true'
        run: |
          python .github/scripts/stl_generator_helper.py --generate-report

      - name: Upload STL artifacts
        if: steps.generate.outputs.should_commit == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: stl-files
          path: 3d_models/*.stl

  commit-changes:
    runs-on: ubuntu-latest
    needs: generate-stl
    if: needs.generate-stl.outputs.should_commit == 'true' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download all STL artifacts
        uses: actions/download-artifact@v4
        with:
          name: stl-files
          path: 3d_models/

      - name: Commit and push updated files
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action STL Generator"
          git add "3d_models/*.stl" "3d_models/build_report.md"
          if ! git diff --staged --quiet; then
            git commit -m "ci: Auto-generate STL files and build report"
            git push
          fi
