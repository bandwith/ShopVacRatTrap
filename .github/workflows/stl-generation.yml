---
name: Generate STL Files from SCAD

on:
  push:
    branches:
      - main
  pull_request:
    paths:
      - 3d_models/**.scad
  workflow_dispatch:
    inputs:
      force_regenerate:
        description: Force regenerate all STL files even if unchanged
        required: false
        default: false
        type: boolean

jobs:
  generate-stl:
    runs-on: ubuntu-latest
    outputs:
      should_commit: ${{ steps.generate.outputs.should_commit }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5.0.0
        with:
          fetch-depth: 0

      - name: Install uv
        uses: astral-sh/setup-uv@v7.1.3
        with:
          enable-cache: true
          cache-dependency-glob: requirements.txt

      - name: Set up Python
        uses: actions/setup-python@v6.0.0
        with:
          python-version: '3.14'

      - name: Install dependencies
        run: uv pip install --system -r requirements.txt

      - name: Cache apt packages
        uses: actions/cache@v4.3.0
        with:
          path: /var/cache/apt/archives
          key: ${{ runner.os }}-apt-openscad
          restore-keys: |
            ${{ runner.os }}-apt-openscad-

      - name: Install OpenSCAD
        run: |
          sudo apt-get update && sudo apt-get install -y openscad

      - name: Generate STL files
        id: generate
        run: |
          scad_files_to_build_json="[]"
          if [[ "${{ github.event.inputs.force_regenerate }}" == "true" ]]; then
            scad_files_to_build_json=$(python .github/scripts/build.py --get-all-files)
          else
            changed_files=$(python .github/scripts/build.py --get-changed-files)
            missing_files=$(python .github/scripts/build.py --get-missing-files)
            scad_files_to_build_json=$(jq -n \
            --argjson a "$changed_files" \
            --argjson b "$missing_files" \
            '$a + $b | unique')
          fi

          if [[ -z "$scad_files_to_build_json" || "$scad_files_to_build_json" == "[]" ]]; then
            echo "No SCAD files to process."
            echo "should_commit=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "should_commit=true" >> $GITHUB_OUTPUT
          scad_files_to_build=$(echo "$scad_files_to_build_json" | jq -r '.[]' | tr '\n' ' ')
          python .github/scripts/build.py --build $scad_files_to_build

      - name: Upload STL artifacts
        if: steps.generate.outputs.should_commit == 'true'
        uses: actions/upload-artifact@v5.0.0
        with:
          name: stl-files
          path: 3d_models/*.stl

  commit-changes:
    runs-on: ubuntu-latest
    needs: generate-stl
    if: needs.generate-stl.outputs.should_commit == 'true' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5.0.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download all STL artifacts
        uses: actions/download-artifact@v6.0.0
        with:
          name: stl-files
          path: 3d_models/

      - name: Commit and push updated files
        uses: stefanzweifel/git-auto-commit-action@v7.0.0
        with:
          commit_user_email: action@github.com
          commit_user_name: GitHub Action STL Generator
          commit_message: 'ci: Auto-generate STL files and build report'
          file_pattern: 3d_models/*.stl 3d_models/build_report.md
