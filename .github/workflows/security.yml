---
name: Security Scan

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    # Run daily at 2 AM UTC to catch new vulnerabilities
    - cron: 0 2 * * *
  workflow_dispatch: # Allow manual triggers

jobs:
  trivy-scan:
    runs-on: ubuntu-latest

    permissions:
      contents: read # For checkout
      security-events: write # For uploading SARIF results

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: fs
          scan-ref: .
          format: sarif
          output: trivy-results.sarif
          severity: CRITICAL,HIGH,MEDIUM # Include MEDIUM severity
          scanners: vuln,secret,misconfig # Scan for secrets and misconfigurations

      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-results.sarif
          category: trivy-fs

  python-security:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: pip

      - name: Install pip-audit and sarif-tools
        run: pip install pip-audit sarif-tools

      - name: Run pip-audit on requirements.txt
        continue-on-error: true
        run: |
          pip-audit --disable-pip \
            -r requirements.txt \
            --format json \
            --output pip-audit-results.json

      - name: Convert pip-audit results to SARIF
        if: always()
        continue-on-error: true
        run: |
          # Convert JSON to SARIF format
          python3 << 'EOF'
          import json
          import os

          # Read pip-audit JSON results
          if not os.path.exists('pip-audit-results.json'):
              print("No pip-audit results found, skipping SARIF conversion")
              exit(0)

          with open('pip-audit-results.json', 'r') as f:
              audit_data = json.load(f)

          # Create SARIF structure
          sarif = {
              "version": "2.1.0",
              "$schema": "https://raw.githubusercontent.com/oasis-tcs/sarif-spec/master/Schemata/sarif-schema-2.1.0.json",
              "runs": [{
                  "tool": {
                      "driver": {
                          "name": "pip-audit",
                          "informationUri": "https://github.com/pypa/pip-audit",
                          "version": "2.9.0",
                          "rules": []
                      }
                  },
                  "results": []
              }]
          }

          # Process vulnerabilities
          for vuln in audit_data.get('dependencies', []):
              for issue in vuln.get('vulns', []):
                  rule_id = issue.get('id', 'UNKNOWN')

                  # Add rule if not exists
                  if not any(r['id'] == rule_id for r in sarif['runs'][0]['tool']['driver']['rules']):
                      sarif['runs'][0]['tool']['driver']['rules'].append({
                          "id": rule_id,
                          "name": rule_id,
                          "shortDescription": {"text": issue.get('description', 'Security vulnerability')},
                          "helpUri": issue.get('fix_versions', [{}])[0].get('link', ''),
                          "properties": {
                              "security-severity": "7.0"
                          }
                      })

                  # Add result
                  sarif['runs'][0]['results'].append({
                      "ruleId": rule_id,
                      "level": "warning",
                      "message": {
                          "text": f"Vulnerable dependency: {vuln['name']}=={vuln['version']} - {issue.get('description', 'No description')}"
                      },
                      "locations": [{
                          "physicalLocation": {
                              "artifactLocation": {
                                  "uri": "requirements.txt"
                              },
                              "region": {
                                  "startLine": 1
                              }
                          }
                      }]
                  })

          # Write SARIF file
          with open('pip-audit-results.sarif', 'w') as f:
              json.dump(sarif, f, indent=2)

          print(f"Converted {len(sarif['runs'][0]['results'])} vulnerabilities to SARIF format")
          EOF

      - name: Upload pip-audit results
        if: always()
        uses: github/codeql-action/upload-sarif@v4
        continue-on-error: true
        with:
          sarif_file: pip-audit-results.sarif
          category: pip-audit

  dependency-review:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: moderate
          comment-summary-in-pr: always
