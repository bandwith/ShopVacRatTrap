---
name: BOM Validation & Monitoring

on:
  schedule:
    # Run weekly on Mondays at 9 AM UTC
    - cron: 0 9 * * 1
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      check_availability:
        description: Check component availability
        required: false
        default: true
        type: boolean
      force_update:
        description: Force update even if prices unchanged
        required: false
        default: false
        type: boolean

env:
  MOUSER_API_KEY: ${{ secrets.MOUSER_API_KEY }}

jobs:
  validate-bom:
    runs-on: ubuntu-latest
    timeout-minutes: 30 # Prevent hangs on long API calls

    permissions:
      contents: write
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5.0.0

      - name: Install uv
        uses: astral-sh/setup-uv@v7.1.3
        with:
          enable-cache: true
          cache-dependency-glob: requirements.txt

      - name: Set up Python
        uses: actions/setup-python@v6.0.0
        with:
          python-version: '3.13'

      - name: Install dependencies
        run: uv pip install --system -r requirements.txt

      - name: Run unit tests
        run: |
          # Run tests if they exist, but don't fail if no tests are found
          pytest .github/scripts/ --tb=short || [ $? -eq 5 ] && echo "No tests found - continuing"
        continue-on-error: false

      - name: Create backup of current BOM and manage older backups
        run: |
          bash ./.github/scripts/backup_bom.sh

      - name: Run BOM validation and generate all files
        id: bom_validation
        run: |
          echo "ðŸ”„ Starting BOM management process..."
          python .github/scripts/bom_manager.py \
            --bom-file BOM_CONSOLIDATED.csv \
            --output-dir purchasing \
            --all
        continue-on-error: false # Fail fast if script errors

      - name: Set validation outputs from generated files
        id: set_validation_outputs
        run: |
          # Check for unavailable components (parse availability_report.md)
          if [ -f availability_report.md ] && grep -qi "unavailable\|out of stock\|low stock" availability_report.md; then
            echo "unavailable_components=true" >> $GITHUB_OUTPUT
            echo "ðŸ“¦ Unavailable components detected"
          else
            echo "unavailable_components=false" >> $GITHUB_OUTPUT
            echo "âœ… All components available"
          fi

          # Check for significant price changes (parse pricing_report.md)
          if [ -f pricing_report.md ] && grep -qi "significant\|major\|increase\|decrease" pricing_report.md; then
            echo "significant_changes=true" >> $GITHUB_OUTPUT
            echo "ðŸ’° Significant price changes detected"
          else
            echo "significant_changes=false" >> $GITHUB_OUTPUT
            echo "ðŸ“Š No significant price changes"
          fi

          # Assume changes detected if files were generated/updated (or force update)
          if [ -f validation_results.json ] || [ "${{ github.event.inputs.force_update }}" == "true" ]; then
            echo "changes_detected=true" >> $GITHUB_OUTPUT
            echo "ðŸ”„ Changes detected in BOM validation"
          else
            echo "changes_detected=false" >> $GITHUB_OUTPUT
            echo "ðŸ”„ No changes detected"
          fi

      - name: Manage Availability Issue
        if: steps.set_validation_outputs.outputs.unavailable_components == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Prepare body
          cp availability_report.md availability_issue_body.md
          cat >> availability_issue_body.md << 'EOF'

          ## ðŸš¨ Action Required

          **Critical components are showing low availability or are out of stock.**

          ### Immediate Actions:
          1. **Review affected components** listed above
          2. **Source alternative suppliers** for out-of-stock items
          3. **Consider alternative components** if needed
          4. **Update BOM** with alternative part numbers if substitutions are made
          5. **Test alternatives** before finalizing changes

          *This alert was automatically generated by the component availability monitoring system.*
          EOF

          # Get Title
          if [ -f availability_issue_title.txt ]; then
            TITLE=$(cat availability_issue_title.txt)
          else
            TITLE="ðŸš¨ Component Availability Alert - Critical Parts Low Stock"
          fi

          # Check for existing open issue
          EXISTING_ISSUE=$(gh issue list --state open --label "availability" --json number --limit 1 | jq '.[0].number')

          if [ "$EXISTING_ISSUE" != "null" ] && [ -n "$EXISTING_ISSUE" ]; then
            echo "Found existing availability issue #$EXISTING_ISSUE. Updating..."
            gh issue comment "$EXISTING_ISSUE" --body "## ðŸ”„ Update: $(date)

            The availability check has run again. Please see the latest report below.

            $(cat availability_report.md)"
          else
            echo "Creating new availability issue..."
            gh issue create \
              --title "$TITLE" \
              --body-file availability_issue_body.md \
              --label "automation,availability,urgent,supply-chain"
          fi

      - name: Manage Pricing Issue
        if: steps.set_validation_outputs.outputs.significant_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Prepare body
          cp pricing_report.md pricing_issue_body.md
          cat >> pricing_issue_body.md << 'EOF'

          ## ðŸ” Action Required

          **Significant price changes have been detected in the BOM components.**

          ### Next Steps:
          1. Review the pricing changes above
          2. Update project cost estimates if needed
          3. Consider alternative components for items with major price increases
          4. Update ELECTRICAL_DESIGN.md cost analysis if total project cost changed significantly
          5. Close this issue once changes have been reviewed and addressed

          *This issue was automatically created by the BOM validation workflow.*
          EOF

          # Check for existing open issue
          EXISTING_ISSUE=$(gh issue list --state open --label "pricing" --json number --limit 1 | jq '.[0].number')

          if [ "$EXISTING_ISSUE" != "null" ] && [ -n "$EXISTING_ISSUE" ]; then
            echo "Found existing pricing issue #$EXISTING_ISSUE. Updating..."
            gh issue comment "$EXISTING_ISSUE" --body "## ðŸ”„ Update: $(date)

            The pricing check has run again. Please see the latest report below.

            $(cat pricing_report.md)"
          else
            echo "Creating new pricing issue..."
            gh issue create \
              --title "âš ï¸ Significant BOM Price Changes Detected" \
              --body-file pricing_issue_body.md \
              --label "automation,pricing,review-needed"
          fi

      - name: Commit and push changes
        if: steps.set_validation_outputs.outputs.changes_detected == 'true' || github.event.inputs.force_update == 'true'
        uses: stefanzweifel/git-auto-commit-action@v7.0.0
        with:
          commit_user_email: action@github.com
          commit_user_name: GitHub Action
          commit_message: ðŸ¤– Auto-update BOM pricing and purchase links - $(date +%Y-%m-%d)
          file_pattern: BOM_*.csv pricing_backup/ purchasing/

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v5.0.0
        with:
          name: bom-validation-${{ github.run_number }}
          path: |
            validation_results.json
            pricing_report.md
            availability_report.md
            pricing_backup/ # Contains the 5 most recent BOM pricing backups
            purchasing/
          retention-days: 30
          if-no-files-found: warn

      - name: Post summary to workflow
        if: always()
        run: |
          echo "## ðŸ’° BOM Validation Summary" >> $GITHUB_STEP_SUMMARY

          if [ -f pricing_report.md ]; then
            cat pricing_report.md >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Pricing validation failed - check logs for details" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -f availability_report.md ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## ðŸ“¦ Availability Report" >> $GITHUB_STEP_SUMMARY
            cat availability_report.md >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Workflow Statistics" >> $GITHUB_STEP_SUMMARY
          echo "- **Run Date**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Changes Detected**: ${{ steps.set_validation_outputs.outputs.changes_detected }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Significant Changes**: ${{ steps.set_validation_outputs.outputs.significant_changes }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Unavailable Components**: ${{ steps.set_validation_outputs.outputs.unavailable_components }}" >> $GITHUB_STEP_SUMMARY
