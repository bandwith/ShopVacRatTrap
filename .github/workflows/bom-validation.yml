---
name: BOM Validation & Monitoring

on:
  schedule:
    # Run weekly on Mondays at 9 AM UTC
    - cron: 0 9 * * 1
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      check_availability:
        description: Check component availability
        required: false
        default: true
        type: boolean
      force_update:
        description: Force update even if prices unchanged
        required: false
        default: false
        type: boolean

env:
  MOUSER_API_KEY: ${{ secrets.MOUSER_API_KEY }}

jobs:
  validate-bom:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      issues: write

    steps:
      - name: Setup Python Environment
        uses: ./.github/actions/setup-python

      - name: Run unit tests
        run: |
          pytest .github/scripts/

      - name: Create backup of current BOM and manage older backups
        run: |
          bash ./.github/scripts/backup_bom.sh

      - name: Run BOM validation and generate all files
        id: bom_validation
        run: |
          echo "ðŸ”„ Starting BOM management process..."
          python .github/scripts/bom_manager.py \
            --bom-file BOM_CONSOLIDATED.csv \
            --output-dir . \
            --all
        continue-on-error: true

      - name: Create alert for unavailable components
        if: steps.bom_validation.outputs.unavailable_components == 'true'
        uses: ./.github/actions/create-github-issue
        with:
          issue-title: ðŸš¨ Component Availability Alert - Critical Parts Low Stock
          report-file: availability_report.md
          labels: automation, availability, urgent, supply-chain
          action-required-message: |
            ## ðŸš¨ Action Required

            **Critical components are showing low availability or are out of stock.**

            ### Immediate Actions:
            1. **Review affected components** listed above
            2. **Source alternative suppliers** for out-of-stock items
            3. **Consider alternative components** if needed
            4. **Update BOM** with alternative part numbers if substitutions are made
            5. **Test alternatives** before finalizing changes

            *This alert was automatically generated by the component availability monitoring system.*

      - name: Create issue for significant price changes
        if: steps.bom_validation.outputs.significant_changes == 'true'
        uses: ./.github/actions/create-github-issue
        with:
          issue-title: âš ï¸ Significant BOM Price Changes Detected
          report-file: pricing_report.md
          labels: automation, pricing, review-needed
          action-required-message: |
            ## ðŸ” Action Required

            **Significant price changes have been detected in the BOM components.**

            ### Next Steps:
            1. Review the pricing changes above
            2. Update project cost estimates if needed
            3. Consider alternative components for items with major price increases
            4. Update ELECTRICAL_DESIGN.md cost analysis if total project cost changed significantly
            5. Close this issue once changes have been reviewed and addressed

            *This issue was automatically created by the BOM validation workflow.*

      - name: Commit and push changes
        if: steps.bom_validation.outputs.changes_detected == 'true' || github.event.inputs.force_update == 'true'
        uses: ./.github/actions/git-config-and-commit
        with:
          user-email: action@github.com
          user-name: GitHub Action
          commit-message: ðŸ¤– Auto-update BOM pricing and purchase links - $(date +%Y-%m-%d)
          files-to-add: BOM_*.csv pricing_backup/ purchasing/

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bom-validation-${{ github.run_number }}
          path: |
            validation_results.json
            pricing_report.md
            availability_report.md
            pricing_backup/ # Contains the 5 most recent BOM pricing backups
            purchasing/
          retention-days: 30

      - name: Post summary to workflow
        if: always()
        run: |
          echo "## ðŸ’° BOM Validation Summary" >> $GITHUB_STEP_SUMMARY

          if [ -f pricing_report.md ]; then
            cat pricing_report.md >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Pricing validation failed - check logs for details" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -f availability_report.md ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## ðŸ“¦ Availability Report" >> $GITHUB_STEP_SUMMARY
            cat availability_report.md >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Workflow Statistics" >> $GITHUB_STEP_SUMMARY
          echo "- **Run Date**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Changes Detected**: ${{ steps.bom_validation.outputs.changes_detected }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Significant Changes**: ${{ steps.bom_validation.outputs.significant_changes }}" \
            >> $GITHUB_STEP_SUMMARY
