---
name: BOM Validation & Monitoring

on:
  schedule:
    # Run weekly on Mondays at 9 AM UTC
    - cron: 0 9 * * 1
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      check_availability:
        description: Check component availability
        required: false
        default: true
        type: boolean
      force_update:
        description: Force update even if prices unchanged
        required: false
        default: false
        type: boolean

env:
  MOUSER_API_KEY: ${{ secrets.MOUSER_API_KEY }}

jobs:
  validate-bom:
    runs-on: ubuntu-latest
    timeout-minutes: 30  # Prevent hangs on long API calls

    permissions:
      contents: write
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: Install uv
        uses: astral-sh/setup-uv@5a7eac68fb9809dea845d802897dc5c723910fa3 # v7.1.3
        with:
          enable-cache: true
          cache-dependency-glob: requirements.txt

      - name: Set up Python
        uses: actions/setup-python@e797f83bcb11b83ae66e0230d6156d7c80228e7c # v6.0.0
        with:
          python-version: '3.14'

      - name: Install dependencies
        run: uv pip install --system -r requirements.txt

      - name: Run unit tests
        run: |
          pytest .github/scripts/ --tb=short  # Shorter traceback for CI logs

      - name: Create backup of current BOM and manage older backups
        run: |
          bash ./.github/scripts/backup_bom.sh

      - name: Run BOM validation and generate all files
        id: bom_validation
        run: |
          echo "ðŸ”„ Starting BOM management process..."
          python .github/scripts/bom_manager.py \
            --bom-file BOM_CONSOLIDATED.csv \
            --output-dir . \
            --all
        continue-on-error: false  # Fail fast if script errors

      - name: Set validation outputs from generated files
        id: set_validation_outputs
        run: |
          # Check for unavailable components (parse availability_report.md)
          if [ -f availability_report.md ] && grep -qi "unavailable\|out of stock\|low stock" availability_report.md; then
            echo "unavailable_components=true" >> $GITHUB_OUTPUT
            echo "ðŸ“¦ Unavailable components detected"
          else
            echo "unavailable_components=false" >> $GITHUB_OUTPUT
            echo "âœ… All components available"
          fi

          # Check for significant price changes (parse pricing_report.md)
          if [ -f pricing_report.md ] && grep -qi "significant\|major\|increase\|decrease" pricing_report.md; then
            echo "significant_changes=true" >> $GITHUB_OUTPUT
            echo "ðŸ’° Significant price changes detected"
          else
            echo "significant_changes=false" >> $GITHUB_OUTPUT
            echo "ðŸ“Š No significant price changes"
          fi

          # Assume changes detected if files were generated/updated (or force update)
          if [ -f validation_results.json ] || [ "${{ github.event.inputs.force_update }}" == "true" ]; then
            echo "changes_detected=true" >> $GITHUB_OUTPUT
            echo "ðŸ”„ Changes detected in BOM validation"
          else
            echo "changes_detected=false" >> $GITHUB_OUTPUT
            echo "ðŸ”„ No changes detected"
          fi

      - name: Prepare availability issue body
        if: steps.set_validation_outputs.outputs.unavailable_components == 'true'
        run: |
          cp availability_report.md availability_issue_body.md
          cat >> availability_issue_body.md << 'EOF'

          ## ðŸš¨ Action Required

          **Critical components are showing low availability or are out of stock.**

          ### Immediate Actions:
          1. **Review affected components** listed above
          2. **Source alternative suppliers** for out-of-stock items
          3. **Consider alternative components** if needed
          4. **Update BOM** with alternative part numbers if substitutions are made
          5. **Test alternatives** before finalizing changes

          *This alert was automatically generated by the component availability monitoring system.*
          EOF

      - name: Create alert for unavailable components
        if: steps.set_validation_outputs.outputs.unavailable_components == 'true'
        uses: peter-evans/create-issue-from-file@e8ef132d6df98ed982188e460ebb3b5d4ef3a9cd # v5.0.1
        with:
          title: ðŸš¨ Component Availability Alert - Critical Parts Low Stock
          content-filepath: availability_issue_body.md
          labels: automation, availability, urgent, supply-chain

      - name: Prepare pricing issue body
        if: steps.set_validation_outputs.outputs.significant_changes == 'true'
        run: |
          cp pricing_report.md pricing_issue_body.md
          cat >> pricing_issue_body.md << 'EOF'

          ## ðŸ” Action Required

          **Significant price changes have been detected in the BOM components.**

          ### Next Steps:
          1. Review the pricing changes above
          2. Update project cost estimates if needed
          3. Consider alternative components for items with major price increases
          4. Update ELECTRICAL_DESIGN.md cost analysis if total project cost changed significantly
          5. Close this issue once changes have been reviewed and addressed

          *This issue was automatically created by the BOM validation workflow.*
          EOF

      - name: Create issue for significant price changes
        if: steps.set_validation_outputs.outputs.significant_changes == 'true'
        uses: peter-evans/create-issue-from-file@e8ef132d6df98ed982188e460ebb3b5d4ef3a9cd # v5.0.1
        with:
          title: âš ï¸ Significant BOM Price Changes Detected
          content-filepath: pricing_issue_body.md
          labels: automation, pricing, review-needed

      - name: Commit and push changes
        if: steps.set_validation_outputs.outputs.changes_detected == 'true' || github.event.inputs.force_update == 'true'
        uses: stefanzweifel/git-auto-commit-action@b863ae1933cb653a53c021fe36dbb774e1fb9403 # v5.2.0
        with:
          commit_user_email: action@github.com
          commit_user_name: GitHub Action
          commit_message: ðŸ¤– Auto-update BOM pricing and purchase links - $(date +%Y-%m-%d)
          file_pattern: BOM_*.csv pricing_backup/ purchasing/

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: bom-validation-${{ github.run_number }}
          path: |
            validation_results.json
            pricing_report.md
            availability_report.md
            pricing_backup/ # Contains the 5 most recent BOM pricing backups
            purchasing/
          retention-days: 30
          if-no-files-found: warn

      - name: Post summary to workflow
        if: always()
        run: |
          echo "## ðŸ’° BOM Validation Summary" >> $GITHUB_STEP_SUMMARY

          if [ -f pricing_report.md ]; then
            cat pricing_report.md >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Pricing validation failed - check logs for details" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -f availability_report.md ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## ðŸ“¦ Availability Report" >> $GITHUB_STEP_SUMMARY
            cat availability_report.md >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Workflow Statistics" >> $GITHUB_STEP_SUMMARY
          echo "- **Run Date**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Changes Detected**: ${{ steps.set_validation_outputs.outputs.changes_detected }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Significant Changes**: ${{ steps.set_validation_outputs.outputs.significant_changes }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Unavailable Components**: ${{ steps.set_validation_outputs.outputs.unavailable_components }}" >> $GITHUB_STEP_SUMMARY
