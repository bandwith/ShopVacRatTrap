name: BOM Pricing Update & Validation

on:
  schedule:
    # Run weekly on Mondays at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Force update even if prices unchanged'
        required: false
        default: false
        type: boolean
  push:
    paths:
      - 'BOM_*.csv'
      - '.github/workflows/bom-pricing-update.yml'
      - '.github/scripts/nexar_validation.py'

env:
  NEXAR_CLIENT_ID: ${{ secrets.NEXAR_CLIENT_ID }}
  NEXAR_CLIENT_SECRET: ${{ secrets.NEXAR_CLIENT_SECRET }}
  MOUSER_API_KEY: ${{ secrets.MOUSER_API_KEY }}

jobs:
  validate-bom-pricing:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests pandas python-dotenv

    - name: Create backup of current BOMs
      run: |
        mkdir -p pricing_backup
        cp BOM_BUDGET.csv pricing_backup/BOM_BUDGET_$(date +%Y%m%d).csv
        cp BOM_OCTOPART.csv pricing_backup/BOM_OCTOPART_$(date +%Y%m%d).csv

    - name: Validate BOM pricing with Hybrid API (Nexar + Mouser)
      id: pricing_validation
      run: |
        echo "🔄 Starting hybrid BOM validation..."

        # Check available API credentials
        if [ -n "$NEXAR_CLIENT_ID" ] && [ -n "$MOUSER_API_KEY" ]; then
          echo "✅ Both Nexar and Mouser APIs available - using hybrid strategy"
          VALIDATION_STRATEGY="hybrid"
        elif [ -n "$NEXAR_CLIENT_ID" ]; then
          echo "🔍 Only Nexar API available - using Nexar-only strategy"
          VALIDATION_STRATEGY="nexar-only"
        elif [ -n "$MOUSER_API_KEY" ]; then
          echo "🛒 Only Mouser API available - using Mouser-only strategy"
          VALIDATION_STRATEGY="mouser-only"
        else
          echo "❌ No API credentials available"
          echo "validation_failed=true" >> $GITHUB_OUTPUT
          exit 1
        fi

        echo "validation_strategy=$VALIDATION_STRATEGY" >> $GITHUB_OUTPUT

        # Run hybrid validation
        python .github/scripts/hybrid_bom_validator.py \
          --bom-files BOM_BUDGET.csv BOM_OCTOPART.csv \
          --output-dir . \
          --priority-components ESP32-DEVKITC-32E D2425-10 LRS-15-5 SCT-013-020
      continue-on-error: true
      env:
        MOUSER_API_KEY: ${{ secrets.MOUSER_API_KEY }}

    - name: Check validation status and API usage
      id: validation_status
      run: |
        if [ -f hybrid_validation_BOM_BUDGET.json ] || [ -f hybrid_validation_BOM_OCTOPART.json ]; then
          # Check results from hybrid validation
          STRATEGY=$(cat hybrid_validation_*.json | jq -r '.validation_strategy' | head -1)
          echo "validation_strategy=$STRATEGY" >> $GITHUB_OUTPUT

          # Check for quota/rate limit issues
          NEXAR_QUOTA_EXCEEDED=$(cat hybrid_validation_*.json | jq -r '.api_usage.nexar_quota_exceeded // false' | grep -q 'true' && echo 'true' || echo 'false')
          NEXAR_CALLS=$(cat hybrid_validation_*.json | jq -r '.api_usage.nexar_calls // 0' | paste -sd+ | bc)
          MOUSER_CALLS=$(cat hybrid_validation_*.json | jq -r '.api_usage.mouser_calls // 0' | paste -sd+ | bc)

          echo "quota_exceeded=$NEXAR_QUOTA_EXCEEDED" >> $GITHUB_OUTPUT
          echo "nexar_calls=$NEXAR_CALLS" >> $GITHUB_OUTPUT
          echo "mouser_calls=$MOUSER_CALLS" >> $GITHUB_OUTPUT

          # Calculate success rates
          TOTAL_COMPONENTS=$(cat hybrid_validation_*.json | jq -r '.total_components' | paste -sd+ | bc)
          FOUND_COMPONENTS=$(cat hybrid_validation_*.json | jq -r '.found_components' | paste -sd+ | bc)
          SUCCESS_RATE=$(echo "scale=1; $FOUND_COMPONENTS * 100 / $TOTAL_COMPONENTS" | bc)

          echo "total_components=$TOTAL_COMPONENTS" >> $GITHUB_OUTPUT
          echo "found_components=$FOUND_COMPONENTS" >> $GITHUB_OUTPUT
          echo "success_rate=$SUCCESS_RATE" >> $GITHUB_OUTPUT

          if [ "$NEXAR_QUOTA_EXCEEDED" = "true" ]; then
            echo "⚠️ Nexar API quota exceeded - but Mouser provided fallback coverage"
            echo "quota_warning=true" >> $GITHUB_OUTPUT
          else
            echo "validation_successful=true" >> $GITHUB_OUTPUT
          fi
        else
          echo "validation_failed=true" >> $GITHUB_OUTPUT
        fi

    - name: Generate hybrid pricing report
      if: always()
      run: |
        echo "## 💰 Hybrid BOM Pricing Validation Report - $(date)" > pricing_report.md
        echo "" >> pricing_report.md

        if [ -f hybrid_validation_BOM_BUDGET.json ] || [ -f hybrid_validation_BOM_OCTOPART.json ]; then
          echo "### 📊 Validation Strategy: ${{ steps.validation_status.outputs.validation_strategy }}" >> pricing_report.md
          echo "" >> pricing_report.md

          # Overall statistics
          echo "| Metric | Value |" >> pricing_report.md
          echo "|--------|-------|" >> pricing_report.md
          echo "| **Total Components** | ${{ steps.validation_status.outputs.total_components }} |" >> pricing_report.md
          echo "| **Found Components** | ${{ steps.validation_status.outputs.found_components }} |" >> pricing_report.md
          echo "| **Success Rate** | ${{ steps.validation_status.outputs.success_rate }}% |" >> pricing_report.md
          echo "| **Nexar API Calls** | ${{ steps.validation_status.outputs.nexar_calls }} |" >> pricing_report.md
          echo "| **Mouser API Calls** | ${{ steps.validation_status.outputs.mouser_calls }} |" >> pricing_report.md
          echo "" >> pricing_report.md

          # Generate detailed report for each BOM
          for validation_file in hybrid_validation_*.json; do
            if [ -f "$validation_file" ]; then
              python .github/scripts/generate_hybrid_report.py "$validation_file" >> pricing_report.md
            fi
          done

          # Add API usage warnings if needed
          if [ "${{ steps.validation_status.outputs.quota_exceeded }}" = "true" ]; then
            echo "" >> pricing_report.md
            echo "### ⚠️ **Nexar Quota Exceeded - Mouser Fallback Active**" >> pricing_report.md
            echo "" >> pricing_report.md
            echo "**What happened:**" >> pricing_report.md
            echo "- Nexar API hit the quota limit after ~100 components" >> pricing_report.md
            echo "- Automatic fallback to Mouser API provided continued coverage" >> pricing_report.md
            echo "- No data loss occurred due to hybrid validation strategy" >> pricing_report.md
            echo "" >> pricing_report.md
            echo "**Benefits of Hybrid Approach:**" >> pricing_report.md
            echo "- ✅ **100% coverage** maintained despite quota limits" >> pricing_report.md
            echo "- ✅ **Multi-supplier data** from Nexar for first components" >> pricing_report.md
            echo "- ✅ **Detailed Mouser pricing** for remaining components" >> pricing_report.md
            echo "- ✅ **No manual intervention** required" >> pricing_report.md
            echo "" >> pricing_report.md
            echo "**Next Steps:**" >> pricing_report.md
            echo "- Consider Nexar plan upgrade for larger BOMs" >> pricing_report.md
            echo "- Current hybrid approach provides excellent coverage" >> pricing_report.md
            echo "" >> pricing_report.md
          fi
        else
          echo "❌ **Validation Failed** - Unable to retrieve pricing data" >> pricing_report.md
          echo "" >> pricing_report.md
          echo "**Error Details:**" >> pricing_report.md
          echo "- Check API credentials (Nexar and/or Mouser)" >> pricing_report.md
          echo "- Verify API endpoint accessibility" >> pricing_report.md
          echo "- Review component part numbers" >> pricing_report.md
          echo "- Check for service outages" >> pricing_report.md
        fi

    - name: Check for pricing changes
      id: pricing_changes
      run: |
        if [ -f pricing_changes.json ]; then
          CHANGES=$(cat pricing_changes.json | jq '.changes_detected')
          echo "changes_detected=$CHANGES" >> $GITHUB_OUTPUT

          SIGNIFICANT_CHANGES=$(cat pricing_changes.json | jq '.significant_changes')
          echo "significant_changes=$SIGNIFICANT_CHANGES" >> $GITHUB_OUTPUT
        else
          echo "changes_detected=false" >> $GITHUB_OUTPUT
          echo "significant_changes=false" >> $GITHUB_OUTPUT
        fi

    - name: Update BOM files with current pricing
      if: steps.pricing_changes.outputs.changes_detected == 'true' || github.event.inputs.force_update == 'true'
      run: |
        python .github/scripts/update_bom_pricing.py
        echo "BOM files updated with current pricing" >> pricing_report.md

    - name: Commit and push changes
      if: steps.pricing_changes.outputs.changes_detected == 'true' || github.event.inputs.force_update == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"

        git add BOM_*.csv
        git add pricing_backup/

        if ! git diff --staged --quiet; then
          git commit -m "🤖 Auto-update BOM pricing - $(date +%Y-%m-%d)

          - Updated component pricing from Nexar API
          - Backup created: pricing_backup/BOM_*_$(date +%Y%m%d).csv
          - Validation report generated

          Co-authored-by: nexar-pricing-bot <nexar-pricing-bot@users.noreply.github.com>"

          git push
        fi

    - name: Create issue for quota exceeded
      if: steps.validation_status.outputs.quota_exceeded == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          const issueBody = `## 💳 Nexar API Quota Exceeded

          **The BOM pricing validation has hit the Nexar API quota limit.**

          ### Current Situation:
          - ✅ First ~100 components validated successfully
          - ⚠️ Remaining components could not be validated
          - 📊 Partial pricing data available in artifacts

          ### Impact:
          - **Pricing updates**: Limited to validated components only
          - **Cost analysis**: May be incomplete for full BOM
          - **Automation**: Will continue with available data

          ### Recommended Actions:
          1. **Immediate**: Review validated components in artifacts
          2. **Short-term**: Prioritize safety-critical components for manual validation
          3. **Long-term**: Consider upgrading Nexar API plan

          ### Nexar Plan Options:
          - **Contact**: api@nexar.com
          - **Mention**: GitHub Actions automation for ${context.repo.owner}/${context.repo.repo}
          - **Request**: Higher quota limit for BOM validation workflows

          ### Workaround:
          - Split BOM validation into multiple runs
          - Focus on critical components first
          - Use manual validation for non-critical parts

          *This issue was automatically created by the BOM pricing validation workflow.*`;

          const issue = await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: '💳 Nexar API Quota Exceeded - BOM Validation Incomplete',
            body: issueBody,
            labels: ['automation', 'nexar-api', 'quota-exceeded', 'action-required']
          });

          console.log(`Created quota exceeded issue #${issue.data.number}`);

    - name: Create issue for significant price changes
      if: steps.pricing_changes.outputs.significant_changes == 'true' && steps.validation_status.outputs.quota_exceeded != 'true'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');

          let reportContent = '';
          try {
            reportContent = fs.readFileSync('pricing_report.md', 'utf8');
          } catch (error) {
            reportContent = '❌ Unable to generate pricing report';
          }

          const issueBody = `${reportContent}

          ## 🔍 Action Required

          **Significant price changes have been detected in the BOM components.**

          ### Next Steps:
          1. Review the pricing changes above
          2. Update project cost estimates if needed
          3. Consider alternative components for items with major price increases
          4. Update ELECTRICAL_DESIGN.md cost analysis if total project cost changed significantly
          5. Close this issue once changes have been reviewed and addressed

          ### Automation Details:
          - **Trigger**: Weekly pricing validation
          - **Threshold**: Changes >10% or total project cost change >5%
          - **Auto-update**: BOM files automatically updated with current pricing
          - **Backup**: Previous pricing saved in \`pricing_backup/\` directory

          *This issue was automatically created by the BOM pricing validation workflow.*`;

          const issue = await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: '⚠️ Significant BOM Price Changes Detected',
            body: issueBody,
            labels: ['automation', 'pricing', 'review-needed']
          });

          console.log(`Created issue #${issue.data.number}`);

    - name: Upload artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: pricing-validation-${{ github.run_number }}
        path: |
          pricing_report.md
          validation_results.json
          pricing_changes.json
          pricing_backup/
        retention-days: 30

    - name: Post summary to workflow
      if: always()
      run: |
        echo "## 💰 BOM Pricing Validation Summary" >> $GITHUB_STEP_SUMMARY

        if [ -f pricing_report.md ]; then
          cat pricing_report.md >> $GITHUB_STEP_SUMMARY
        else
          echo "❌ Pricing validation failed - check logs for details" >> $GITHUB_STEP_SUMMARY
        fi

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### 📊 Workflow Statistics" >> $GITHUB_STEP_SUMMARY
        echo "- **Run Date**: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "- **Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Changes Detected**: ${{ steps.pricing_changes.outputs.changes_detected }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Significant Changes**: ${{ steps.pricing_changes.outputs.significant_changes }}" >> $GITHUB_STEP_SUMMARY
