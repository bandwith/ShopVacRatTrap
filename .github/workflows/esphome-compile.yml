---
name: ESPHome Compile Test

on:
  push:
    branches: [main]
    tags:
      - v*
  pull_request:
    branches: [main]
  release:
    types: [created]

jobs:
  compile:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        yaml-file:
          - esphome/rat-trap.yaml
          - esphome/rat-trap-stemma-camera.yaml

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5.0.0

      - name: Install uv
        uses: astral-sh/setup-uv@v7.1.3
        with:
          enable-cache: true
          cache-dependency-glob: requirements.txt

      - name: Set up Python
        uses: actions/setup-python@v6.0.0
        with:
          python-version: '3.13'

      - name: Cache ESPHome and PlatformIO
        uses: actions/cache@v4
        with:
          path: |
            ~/.platformio
            .esphome
          key: ${{ runner.os }}-esphome-${{ hashFiles('esphome/*.yaml') }}
          restore-keys: |
            ${{ runner.os }}-esphome-

      - name: Sync Python dependencies (frozen)
        run: uv pip install --system -r requirements.txt

      - name: Create dummy secrets.yaml (base64 encoded)
        run: |
          # Create base64-encoded dummy secrets used by esphome packages that expect <name>_base64
          # ESPHome requires 32-byte keys, which when base64 encoded produce 44-character strings
          WIFI_SSID_BASE64=$(echo -n "dummy_ssid" | base64)
          WIFI_PASSWORD_BASE64=$(echo -n "dummy_password" | base64)
          OTA_PASSWORD_BASE64=$(echo -n "dummy_ota_password" | base64)
          # Generate a proper 32-byte random key for API encryption (results in 44 chars base64)
          API_ENCRYPTION_KEY_BASE64=$(openssl rand -base64 32)
          AP_PASSWORD_BASE64=$(echo -n "dummy_ap_password" | base64)

          # Write base64-encoded dummy secrets into file
          echo "# Dummy secrets for CI â€” base64 encoded so files that expect <name>_base64 work" > esphome/secrets.yaml
          echo "wifi_ssid_base64: $WIFI_SSID_BASE64" >> esphome/secrets.yaml
          echo "wifi_password_base64: $WIFI_PASSWORD_BASE64" >> esphome/secrets.yaml
          echo "ota_password_base64: $OTA_PASSWORD_BASE64" >> esphome/secrets.yaml
          echo "api_encryption_key_base64: $API_ENCRYPTION_KEY_BASE64" >> esphome/secrets.yaml
          echo "ap_password_base64: $AP_PASSWORD_BASE64" >> esphome/secrets.yaml
          echo "" >> esphome/secrets.yaml
          echo "# Non-sensitive device names remain in plain text" >> esphome/secrets.yaml
          echo "device_name: dummy_device_name" >> esphome/secrets.yaml
          echo "friendly_name: dummy_friendly_name" >> esphome/secrets.yaml

      - name: Build ESPHome firmware
        uses: esphome/build-action@v7.1.0
        id: esphome-build
        with:
          yaml-file: ${{ matrix.yaml-file }}

      - name: Upload firmware artifacts
        uses: actions/upload-artifact@v5.0.0
        if: always()
        with:
          name: firmware-${{ matrix.yaml-file }}
          path: |
            ${{ steps.esphome-build.outputs.name }}/*.bin
            ${{ steps.esphome-build.outputs.name }}/*.factory.bin
            ${{ steps.esphome-build.outputs.name }}/*.ota.bin
            ${{ steps.esphome-build.outputs.name }}/manifest.json
          retention-days: 30
          if-no-files-found: warn

  release-firmware:
    runs-on: ubuntu-latest
    needs: compile
    if: github.event_name == 'release'
    permissions:
      contents: write

    steps:
      - name: Download all firmware artifacts
        uses: actions/download-artifact@v6.0.0
        with:
          path: firmware-artifacts
          pattern: firmware-*
          merge-multiple: true

      - name: Create firmware archive
        run: |
          cd firmware-artifacts
          zip -r ../rat-trap-firmware-${{ github.ref_name }}.zip .
          cd ..

      - name: Upload firmware to release
        uses: softprops/action-gh-release@v2.4.2
        with:
          files: rat-trap-firmware-${{ github.ref_name }}.zip
          fail_on_unmatched_files: true
          body: |
            ## ðŸ”Œ Firmware Files

            This release includes pre-compiled firmware for:
            - `rat-trap.yaml` - Standard configuration with ToF sensor
            - `rat-trap-stemma-camera.yaml` - Camera-enhanced configuration

            ### ðŸ“¥ Installation Methods

            **Method 1: Web Flasher (Recommended for first install)**
            1. Connect ESP32 via USB
            2. Visit [ESPHome Web](https://web.esphome.io/)
            3. Upload the `.factory.bin` file

            **Method 2: OTA Update (For existing installations)**
            1. Download the `.ota.bin` file
            2. Use Home Assistant ESPHome dashboard
            3. Click "Install" â†’ "Manual download" â†’ Select file

            **Method 3: ESPHome CLI**
            ```bash
            esphome run rat-trap.yaml --device /dev/ttyUSB0
            ```
