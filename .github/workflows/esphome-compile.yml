---
name: ESPHome Compile Test

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  compile:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python Environment
        uses: ./.github/actions/setup-python

      - name: Cache ESPHome build directory
        uses: actions/cache@v4
        with:
          path: ~/.esphome
          key: ${{ runner.os }}-esphome-${{ hashFiles('esphome/*.yaml') }}
          restore-keys: |
            ${{ runner.os }}-esphome-

      - name: Create dummy secrets.yaml (base64 encoded)
        run: |
          # Create base64-encoded dummy secrets used by esphome packages that expect <name>_base64
          WIFI_SSID_BASE64=$(echo -n "dummy_ssid" | base64)
          WIFI_PASSWORD_BASE64=$(echo -n "dummy_password" | base64)
          OTA_PASSWORD_BASE64=$(echo -n "dummy_ota_password" | base64)
          API_ENCRYPTION_KEY_BASE64=$(echo -n "dummy_api_encryption_key" | base64)
          AP_PASSWORD_BASE64=$(echo -n "dummy_ap_password" | base64)

          # Write base64-encoded dummy secrets into file
          echo "# Dummy secrets for CI â€” base64 encoded so files that expect <name>_base64 work" > esphome/secrets.yaml
          echo "wifi_ssid_base64: $WIFI_SSID_BASE64" >> esphome/secrets.yaml
          echo "wifi_password_base64: $WIFI_PASSWORD_BASE64" >> esphome/secrets.yaml
          echo "ota_password_base64: $OTA_PASSWORD_BASE64" >> esphome/secrets.yaml
          echo "api_encryption_key_base64: $API_ENCRYPTION_KEY_BASE64" >> esphome/secrets.yaml
          echo "ap_password_base64: $AP_PASSWORD_BASE64" >> esphome/secrets.yaml
          echo "" >> esphome/secrets.yaml
          echo "# Non-sensitive device names remain in plain text" >> esphome/secrets.yaml
          echo "device_name: dummy_device_name" >> esphome/secrets.yaml
          echo "friendly_name: dummy_friendly_name" >> esphome/secrets.yaml

      - name: Compile ESPHome configurations
        run: |
          echo "Compiling esphome/rat-trap-2025.yaml..."
          esphome compile esphome/rat-trap-2025.yaml
          echo "Compiling esphome/rat-trap-stemma-camera.yaml..."
          esphome compile esphome/rat-trap-stemma-camera.yaml
